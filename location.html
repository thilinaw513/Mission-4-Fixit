<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>FixIt — Location</title>

  <link rel="stylesheet" href="styles.css"/>

  <!-- Leaflet (no API key) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin="anonymous"
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin="anonymous"
    defer
  ></script>

  <!-- Minimal overlay guarantees (keeps working even if styles.css is missing these) -->
  <style>
    /* Full-screen overlay above the map/content */
    #locOverlay{
      position:absolute; inset:0;
      display:grid; place-items:center;
      background:rgba(0,0,0,.18);
      z-index:1000;
    }
    #locOverlay[hidden]{ display:none; }

    /* While locating, make the map non-interactive */
    .stage.loading .leaflet-container{
      pointer-events:none;
    }
  </style>
</head>

<body>
  <div class="stage">
    <div class="screen">
      <header><h1>Where’s the <br>issue?</h1></header>

      <main class="pane">
        <!-- Live map -->
        <div class="card map-card">
          <div id="map" aria-label="Map"></div>
        </div>

        <div class="center mt12">
          <button id="locateBtn" class="btn btn-ghost" type="button">
            Use my location
          </button>
        </div>
      </main>

      <footer class="rail">
        <a class="btn btn-ghost" href="details.html">Back</a>
        <a class="btn grow" href="contact-info-page.html">Next</a>
      </footer>

      <!-- Locating overlay -->
      <div class="overlay" id="locOverlay" hidden>
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="locTitle">
          <h2 id="locTitle" class="center">Finding your location…</h2>
          <div class="spinner" aria-hidden="true"></div>
          <p class="center muted">Using GPS to drop a pin near you.</p>
          <div class="center mt12">
            <button id="cancelLocate" class="btn btn-ghost" type="button">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
  (() => {
    // DOM refs
    const stage   = document.querySelector('.stage');
    const overlay = document.getElementById('locOverlay');
    const btn     = document.getElementById('locateBtn');
    const cancel  = document.getElementById('cancelLocate');

    // Map setup
    const DEFAULT = [-36.8485, 174.7633]; // Auckland CBD
    let canceled = false;
    let map, marker;

    function initMap() {
      map = L.map('map', { zoomControl: true }).setView(DEFAULT, 13);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      marker = L.marker(DEFAULT).addTo(map);
    }

    // Overlay helpers
    function showOverlay() {
      canceled = false;
      overlay.hidden = false;
      stage.classList.add('loading');
    }
    function hideOverlay() {
      overlay.hidden = true;
      stage.classList.remove('loading');
    }

    function handleLocateClick() {
      if (!('geolocation' in navigator)) {
        alert('Geolocation is not supported by this browser.');
        return;
      }
      showOverlay();

      navigator.geolocation.getCurrentPosition(
        ({ coords: { latitude, longitude } }) => {
          if (canceled) return; // user cancelled; ignore result
          const latlng = [latitude, longitude];
          marker.setLatLng(latlng);
          map.flyTo(latlng, 16, { duration: 0.7 });
          hideOverlay();
        },
        (err) => {
          hideOverlay();
          const reason = ({
            1: 'Permission denied',
            2: 'Position unavailable',
            3: 'Timeout'
          })[err.code] || 'Unknown error';
          alert('Could not get your location: ' + reason);
        },
        { enableHighAccuracy: true, timeout: 12000, maximumAge: 10000 }
      );
    }

    function handleCancel() {
      canceled = true; // we can’t abort getCurrentPosition; we just ignore the result
      hideOverlay();
    }

    window.addEventListener('load', () => {
      initMap();
      btn.addEventListener('click', handleLocateClick);
      cancel.addEventListener('click', handleCancel);
    });
  })();
  </script>
</body>
</html>
